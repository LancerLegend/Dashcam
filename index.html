<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××¦×œ××ª ×“×¨×š ğŸš—</title>
  <style>
    body {
      font-family: Arial;
      background: #f0f0f0;
      margin: 0;
      padding: 0;
      text-align: center;
      direction: rtl;
    }

    header {
      background: #222;
      color: #fff;
      padding: 10px;
      font-size: 1.6em;
    }

    .video-container {
      position: relative;
      width: 90%;
      max-width: 600px;
      margin: 10px auto;
      background: black;
      border-radius: 10px;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: auto;
      display: block;
    }

    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10;
    }

    .timestamp {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .gps-info {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.3);
      max-width: 250px;
      text-align: right;
    }

    .gps-status {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
    }

    .gps-status.searching {
      color: #ffaa00;
    }

    .gps-status.found {
      color: #00ff00;
    }

    .gps-status.error {
      color: #ff4444;
    }

    .controls {
      margin: 15px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s;
      font-weight: bold;
    }

    button:active {
      transform: scale(0.95);
    }

    .start { background: #22aa22; color: white; }
    .stop { background: #dd3333; color: white; display: none; }
    .toggle { background: #555; color: white; }

    .recording-indicator {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #ff0000;
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      display: none;
      animation: pulse 1s infinite;
    }

    .segment-timer {
      position: absolute;
      top: 50px;
      left: 15px;
      background: rgba(0, 120, 255, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      display: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .gallery {
      padding: 15px;
    }

    .video-box {
      margin: 15px auto;
      width: 90%;
      max-width: 500px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: relative;
    }

    .video-header {
      background: linear-gradient(135deg, #333, #555);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 15px;
      font-size: 0.9em;
    }

    .video-header .actions {
      display: flex;
      gap: 12px;
    }

    .video-header button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 5px;
      transition: background 0.2s;
    }

    .video-header button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .video-box video {
      width: 100%;
      height: auto;
      display: block;
    }

    .locked {
      border: 3px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .info-panel {
      background: rgba(255, 255, 255, 0.95);
      margin: 10px;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>××¦×œ××ª ×“×¨×š ğŸš—</header>

  <div class="video-container">
    <video id="preview" autoplay muted playsinline></video>
    <div class="overlay">
      <div id="timestamp" class="timestamp"></div>
      <div id="gpsInfo" class="gps-info">
        <div>ğŸ“ ××™×§×•×: ×˜×•×¢×Ÿ...</div>
        <div id="coordinates">×§×•××•×¨×“×™× ×˜×•×ª: --</div>
        <div id="accuracy">×“×™×•×§: --</div>
        <div id="speed">××”×™×¨×•×ª: --</div>
      </div>
      <div id="gpsStatus" class="gps-status searching">ğŸ” ××—×¤×© GPS</div>
      <div id="recordingIndicator" class="recording-indicator">ğŸ”´ ××§×œ×™×˜</div>
      <div id="segmentTimer" class="segment-timer">â±ï¸ 0:00</div>
    </div>
  </div>

  <div class="controls">
    <button id="startBtn" class="start">ğŸ“¹ ×”×ª×—×œ ×”×§×œ×˜×”</button>
    <button id="stopBtn" class="stop">â›” ×¢×¦×•×¨ ×”×§×œ×˜×”</button>
    <button id="toggleBtn" class="toggle">ğŸ”„ ×”×—×œ×£ ××¦×œ××”</button>
  </div>

  <div class="info-panel">
    <strong>ğŸ’¡ ××™×“×¢:</strong> ×”××¦×œ××” ×ª×¦×™×’ ×—×•×ª××ª ×–××Ÿ ××œ××” ×•××™×§×•× GPS ×‘×–××Ÿ ×××ª. ×”×§×œ×˜×•×ª ××ª×—×œ×§×•×ª ××•×˜×•××˜×™×ª ×›×œ 2 ×“×§×•×ª. ×•×•×“× ×©× ×ª×ª ×”×¨×©××” ×œ××™×§×•× ×œ×§×‘×œ×ª × ×ª×•× ×™ GPS ××“×•×™×§×™×.
  </div>

  <div id="gallery" class="gallery"></div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const toggleBtn = document.getElementById("toggleBtn");
    const preview = document.getElementById("preview");
    const gallery = document.getElementById("gallery");
    const timestampEl = document.getElementById("timestamp");
    const gpsInfoEl = document.getElementById("gpsInfo");
    const gpsStatusEl = document.getElementById("gpsStatus");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const segmentTimer = document.getElementById("segmentTimer");
    const coordinatesEl = document.getElementById("coordinates");
    const accuracyEl = document.getElementById("accuracy");
    const speedEl = document.getElementById("speed");

    let stream;
    let recorder;
    let chunks = [];
    let currentMode = "environment";
    let timestampInterval;
    let gpsWatchId;
    let currentGPS = { lat: null, lng: null, accuracy: null, speed: null };
    let gpsHistory = [];
    let recordingStartTime = null;
    let segmentStartTime = null;
    let segmentInterval = null;
    let segmentNumber = 0;
    let isRecording = false;
    
    const SEGMENT_DURATION = 2 * 60 * 1000; // 2 minutes in milliseconds

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×—×•×ª××ª ×”×–××Ÿ
    function updateTimestamp() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('he-IL', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const timeStr = now.toLocaleTimeString('he-IL', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      timestampEl.textContent = `${dateStr} ${timeStr}`;
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×˜×™×™××¨ ×”×¤×œ×—
    function updateSegmentTimer() {
      if (segmentStartTime && isRecording) {
        const elapsed = Date.now() - segmentStartTime;
        const remaining = Math.max(0, SEGMENT_DURATION - elapsed);
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        segmentTimer.textContent = `â±ï¸ ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×ª×—×œ×ª ××¢×§×‘ GPS
    function startGPSTracking() {
      if ('geolocation' in navigator) {
        gpsStatusEl.textContent = "ğŸ” ××—×¤×© GPS";
        gpsStatusEl.className = "gps-status searching";

        gpsWatchId = navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude, accuracy, speed } = position.coords;
            
            currentGPS = {
              lat: latitude,
              lng: longitude,
              accuracy: accuracy,
              speed: speed,
              timestamp: Date.now()
            };

            // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª GPS
            coordinatesEl.textContent = `×§×•××•×¨×“×™× ×˜×•×ª: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            accuracyEl.textContent = `×“×™×•×§: ${accuracy ? Math.round(accuracy) + '×' : '×œ× ×–××™×Ÿ'}`;
            speedEl.textContent = `××”×™×¨×•×ª: ${speed ? Math.round(speed * 3.6) + ' ×§×"×©' : '×œ× ×–××™×Ÿ'}`;

            gpsStatusEl.textContent = "ğŸ“¡ GPS ×¤×¢×™×œ";
            gpsStatusEl.className = "gps-status found";

            // ×©××™×¨×ª × ×§×•×“×ª GPS ×œ×”×™×¡×˜×•×¨×™×” ×‘×–××Ÿ ×”×§×œ×˜×”
            if (isRecording) {
              const recordingTime = Date.now() - recordingStartTime;
              gpsHistory.push({
                ...currentGPS,
                recordingTime: recordingTime
              });
            }
          },
          (error) => {
            console.error('GPS Error:', error);
            gpsStatusEl.textContent = "âŒ GPS ×œ× ×–××™×Ÿ";
            gpsStatusEl.className = "gps-status error";
            
            coordinatesEl.textContent = "×§×•××•×¨×“×™× ×˜×•×ª: ×œ× ×–××™×Ÿ";
            accuracyEl.textContent = "×“×™×•×§: ×œ× ×–××™×Ÿ";
            speedEl.textContent = "××”×™×¨×•×ª: ×œ× ×–××™×Ÿ";
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 1000
          }
        );
      } else {
        gpsStatusEl.textContent = "âŒ GPS ×œ× × ×ª××š";
        gpsStatusEl.className = "gps-status error";
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×¦×™×¨×ª ××¢×§×‘ GPS
    function stopGPSTracking() {
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×¤×œ×— ×”×§×œ×˜×” ×—×“×©
    function startNewSegment() {
      if (!isRecording) return;

      // ×¡×™×•× ×”×¤×œ×— ×”×§×•×“× ×× ×§×™×™×
      if (recorder && recorder.state === 'recording') {
        recorder.stop();
      }

      // ××™×¤×•×¡ × ×ª×•× ×™ ×”×¤×œ×—
      chunks = [];
      segmentStartTime = Date.now();
      segmentNumber++;

      // ×™×¦×™×¨×ª ××§×œ×™×˜ ×—×“×©
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        if (chunks.length > 0) {
          const segmentGPS = gpsHistory.filter(point => 
            point.timestamp >= segmentStartTime - 1000 && 
            point.timestamp <= Date.now()
          );
          saveClip(chunks, `×¤×œ×— ${segmentNumber}`, segmentGPS);
        }
        
        // ×”×ª×—×œ×ª ×¤×œ×— ×—×“×© ×× ×¢×“×™×™×Ÿ ××§×œ×™×˜×™×
        if (isRecording) {
          setTimeout(startNewSegment, 100);
        }
      };

      recorder.start();

      // ×”×’×“×¨×ª ×˜×™×™××¨ ×œ×¡×™×•× ×”×¤×œ×—
      setTimeout(() => {
        if (recorder && recorder.state === 'recording' && isRecording) {
          recorder.stop();
        }
      }, SEGMENT_DURATION);
    }

    async function getStream(facingMode) {
      return await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode },
        audio: true
      });
    }

    async function initCamera() {
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await getStream(currentMode);
        preview.srcObject = stream;
        
        // ×”×ª×—×œ×ª ×¢×“×›×•×Ÿ ×—×•×ª××ª ×–××Ÿ
        timestampInterval = setInterval(updateTimestamp, 1000);
        updateTimestamp();
        
        // ×”×ª×—×œ×ª ××¢×§×‘ GPS
        startGPSTracking();
        
      } catch (error) {
        console.error('Error accessing camera:', error);
        alert('×©×’×™××” ×‘×’×™×©×” ×œ××¦×œ××”');
      }
    }

    function startRecording() {
      gpsHistory = [];
      recordingStartTime = Date.now();
      segmentNumber = 0;
      isRecording = true;
      
      // ×”×¦×’×ª ××™× ×“×™×§×˜×•×¨×™ ×”×§×œ×˜×”
      startBtn.disabled = true;
      startBtn.textContent = "ğŸ”´ ××§×œ×™×˜...";
      stopBtn.style.display = "inline";
      recordingIndicator.style.display = "block";
      segmentTimer.style.display = "block";

      // ×”×ª×—×œ×ª ×¢×“×›×•×Ÿ ×˜×™×™××¨ ×”×¤×œ×—
      segmentInterval = setInterval(updateSegmentTimer, 1000);

      // ×”×ª×—×œ×ª ×”×¤×œ×— ×”×¨××©×•×Ÿ
      startNewSegment();
    }

    function stopRecording() {
      isRecording = false;
      
      if (recorder && recorder.state !== "inactive") {
        recorder.stop();
      }

      // × ×™×§×•×™ ×˜×™×™××¨×™×
      if (segmentInterval) {
        clearInterval(segmentInterval);
        segmentInterval = null;
      }

      // ×”×—×–×¨×ª ×××©×§ ×”××©×ª××© ×œ××¦×‘ ×¨×’×™×œ
      startBtn.disabled = false;
      startBtn.textContent = "ğŸ“¹ ×”×ª×—×œ ×”×§×œ×˜×”";
      stopBtn.style.display = "none";
      recordingIndicator.style.display = "none";
      segmentTimer.style.display = "none";
      recordingStartTime = null;
      segmentStartTime = null;
      segmentNumber = 0;
    }

    function saveClip(chunks, label, gpsData) {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const box = document.createElement("div");
      box.className = "video-box";

      const video = document.createElement("video");
      video.src = url;
      video.controls = true;

      const header = document.createElement("div");
      header.className = "video-header";

      const recordingDate = new Date();
      const title = document.createElement("span");
      title.innerHTML = `
        ğŸ¬ ${label}<br>
        ğŸ“… ${recordingDate.toLocaleDateString('he-IL')} ${recordingDate.toLocaleTimeString('he-IL')}<br>
        ğŸ“ ${gpsData.length > 0 ? `${gpsData.length} × ×§×•×“×•×ª GPS` : '×œ×œ× GPS'}
      `;

      const actions = document.createElement("div");
      actions.className = "actions";

      let locked = false;

      const lockBtn = document.createElement("button");
      lockBtn.textContent = "ğŸ”“";
      lockBtn.title = "× ×¢×œ/×‘×˜×œ × ×¢×™×œ×”";
      lockBtn.onclick = () => {
        locked = !locked;
        box.classList.toggle("locked", locked);
        lockBtn.textContent = locked ? "ğŸ”’" : "ğŸ”“";
      };

      const gpsBtn = document.createElement("button");
      gpsBtn.textContent = "ğŸ“";
      gpsBtn.title = "×”×¦×’ ××™×“×¢ GPS";
      gpsBtn.onclick = () => {
        if (gpsData.length > 0) {
          const gpsInfo = gpsData.map((point, index) => 
            `× ×§×•×“×” ${index + 1}: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)} (${Math.round(point.recordingTime / 1000)}s)`
          ).join('\n');
          alert(`××™×“×¢ GPS ×œ×¡×¨×˜×•×Ÿ:\n\n${gpsInfo}`);
        } else {
          alert('××™×Ÿ ××™×“×¢ GPS ×–××™×Ÿ ×œ×¡×¨×˜×•×Ÿ ×–×”');
        }
      };

      const downloadBtn = document.createElement("button");
      downloadBtn.textContent = "ğŸ’¾";
      downloadBtn.title = "×”×•×¨×“ ×¡×¨×˜×•×Ÿ";
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashcam_${label.replace(/\s+/g, '_')}_${recordingDate.toISOString().slice(0, 19).replace(/:/g, '-')}.webm`;
        a.click();
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ğŸ—‘";
      deleteBtn.title = "××—×§ ×¡×¨×˜×•×Ÿ";
      deleteBtn.onclick = () => {
        if (!locked || confirm("×”×¡×¨×˜×•×Ÿ × ×¢×•×œ. ×œ××—×•×§ ×‘×›×œ ×–××ª?")) {
          URL.revokeObjectURL(url);
          box.remove();
        }
      };

      actions.appendChild(lockBtn);
      actions.appendChild(gpsBtn);
      actions.appendChild(downloadBtn);
      actions.appendChild(deleteBtn);
      header.appendChild(title);
      header.appendChild(actions);

      box.appendChild(header);
      box.appendChild(video);
      
      // ×”×•×¡×¤×” ×‘×¨××© ×”×’×œ×¨×™×” (×”×¡×¨×˜×•× ×™× ×”×—×“×©×™× ×™×•×¤×™×¢×• ×œ××¢×œ×”)
      gallery.insertBefore(box, gallery.firstChild);
    }

    toggleBtn.onclick = async () => {
      currentMode = currentMode === "user" ? "environment" : "user";
      await initCamera();
    };

    startBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;

    // × ×™×§×•×™ ××©××‘×™× ×‘×¢×ª ×¡×’×™×¨×ª ×”×“×£
    window.addEventListener('beforeunload', () => {
      stopGPSTracking();
      if (timestampInterval) clearInterval(timestampInterval);
      if (segmentInterval) clearInterval(segmentInterval);
      if (stream) stream.getTracks().forEach(t => t.stop());
    });

    window.onload = initCamera;
  </script>
</body>
</html>